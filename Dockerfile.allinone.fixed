# å¤šé˜¶æ®µæ„å»º - åç«¯ï¼ˆå®Œå…¨æ¨¡ä»¿ AgentXï¼‰
FROM maven:3.9-eclipse-temurin-17 AS backend-builder
WORKDIR /app
COPY pom.xml ./
COPY src ./src
# æ·»åŠ  settings.xml å¦‚æœå­˜åœ¨
COPY settings.xml /root/.m2/settings.xml 2>/dev/null || true
RUN mvn clean package -DskipTests

# æœ€ç»ˆè¿è¡Œé•œåƒ - åŸºäº PostgreSQL é•œåƒï¼ˆæ¨¡ä»¿ AgentXï¼‰
FROM postgres:15-alpine

# å®‰è£… OpenJDK å’Œå¿…è¦å·¥å…·
RUN apk add --no-cache \
    openjdk17-jre \
    curl \
    bash \
    supervisor

# è®¾ç½® PostgreSQL ç¯å¢ƒ
ENV POSTGRES_DB=api_gateway
ENV POSTGRES_USER=gateway_user
ENV POSTGRES_PASSWORD=gateway_pass
ENV PGDATA=/var/lib/postgresql/data

# åˆ›å»ºåº”ç”¨ç›®å½•
WORKDIR /app

# å¤åˆ¶æ„å»ºå¥½çš„ JAR æ–‡ä»¶
COPY --from=backend-builder /app/target/*.jar /app/app.jar

# å¤åˆ¶æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
COPY docs/sql/sql.sql /docker-entrypoint-initdb.d/01-init.sql

# åˆ›å»ºåº”ç”¨é…ç½®æ–‡ä»¶
RUN cat > /app/application-allinone.yml << 'EOF'
server:
  port: 8081

spring:
  application:
    name: api-premium-gateway
  profiles:
    active: allinone
  datasource:
    url: jdbc:postgresql://localhost:5432/api_gateway
    username: gateway_user
    password: gateway_pass
    driver-class-name: org.postgresql.Driver

mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
  global-config:
    db-config:
      logic-delete-field: deleted
      logic-delete-value: 1
      logic-not-delete-value: 0

logging:
  level:
    org.xhy.gateway: INFO
  file:
    name: /app/logs/api-premium-gateway.log
EOF

# åˆ›å»º supervisor é…ç½®ï¼ˆå‚è€ƒ AgentXï¼‰
RUN mkdir -p /etc/supervisor/conf.d && \
    cat > /etc/supervisor/conf.d/gateway.conf << 'EOF'
[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid

[program:postgres]
command=/usr/local/bin/docker-entrypoint.sh postgres
user=postgres
autostart=true
autorestart=true
stdout_logfile=/var/log/postgres.log
stderr_logfile=/var/log/postgres.log
environment=POSTGRES_DB="api_gateway",POSTGRES_USER="gateway_user",POSTGRES_PASSWORD="gateway_pass"

[program:gateway]
command=java -jar /app/app.jar --spring.config.additional-location=file:/app/application-allinone.yml
directory=/app
user=root
autostart=true
autorestart=true
stdout_logfile=/var/log/gateway.log
stderr_logfile=/var/log/gateway.log
EOF

# åˆ›å»ºå¯åŠ¨è„šæœ¬ï¼ˆå‚è€ƒ AgentX çš„ç”¨æˆ·å‹å¥½è¾“å‡ºï¼‰
RUN cat > /app/start-gateway.sh << 'EOF'
#!/bin/bash

echo "ğŸš€ Starting API Premium Gateway All-in-One"
echo "=========================================="

# åˆå§‹åŒ– PostgreSQL æ•°æ®ç›®å½•
if [ ! -d "$PGDATA" ]; then
    echo "ğŸ”§ Initializing PostgreSQL database..."
    mkdir -p "$PGDATA"
    chown postgres:postgres "$PGDATA"
    su - postgres -c "initdb -D $PGDATA"
fi

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p /var/log/supervisor /app/logs

echo "ğŸ¯ Starting all services with supervisor..."

# å¯åŠ¨ supervisor
exec /usr/bin/supervisord -c /etc/supervisor/conf.d/gateway.conf
EOF

RUN chmod +x /app/start-gateway.sh

# åˆ›å»ºå¿…è¦ç›®å½•å’Œè®¾ç½®æƒé™
RUN mkdir -p /var/lib/postgresql/data /var/log /app/logs && \
    chown -R postgres:postgres /var/lib/postgresql && \
    chmod 755 /var/log

# æš´éœ²ç«¯å£
EXPOSE 8081 5432

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
    CMD curl -f http://localhost:8081/api/health || exit 1

# åˆ›å»ºæœ€ç»ˆå¯åŠ¨è„šæœ¬ï¼ŒåŒ…å«ç”¨æˆ·å‹å¥½çš„è¾“å‡º
RUN cat > /docker-entrypoint.sh << 'EOF'
#!/bin/bash

echo "ğŸ‰ Welcome to API Premium Gateway All-in-One!"
echo "=============================================="
echo ""
echo "ğŸ”§ Initializing system..."

# å¯åŠ¨åº”ç”¨
/app/start-gateway.sh &
APP_PID=$!

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "â³ Waiting for services to start (this may take 1-2 minutes)..."
sleep 30

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
for i in {1..40}; do
    if curl -s http://localhost:8081/api/health >/dev/null 2>&1; then
        echo ""
        echo "âœ… All services are ready!"
        echo ""
        echo "ğŸŒ Access URLs:"
        echo "   API Gateway:  http://localhost:8081/api"
        echo "   Health Check: http://localhost:8081/api/health"
        echo "   Database:     postgresql://gateway_user:gateway_pass@localhost:5432/api_gateway"
        echo ""
        echo "ğŸ“š Documentation: https://github.com/lucky-aeon/API-Premium-Gateway"
        echo "ğŸ†˜ Support: https://github.com/lucky-aeon/API-Premium-Gateway/issues"
        echo ""
        break
    fi
    
    if [ $((i % 10)) -eq 0 ]; then
        echo "   Still starting... ($i/40)"
    fi
    sleep 3
done

# ä¿æŒå®¹å™¨è¿è¡Œ
wait $APP_PID
EOF

RUN chmod +x /docker-entrypoint.sh

# è®¾ç½®å…¥å£ç‚¹
ENTRYPOINT ["/docker-entrypoint.sh"]